<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>学习卡片生成</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body { margin:0; background:#f5f7fa; }
    header { background:#0b3d66; color:#fff; padding:10px 16px; display:flex; justify-content:space-between; align-items:center;}
    header h1 { margin:0; font-size:18px; }
    main { max-width:860px; margin:24px auto; background:#fff; padding:28px 34px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.06);}
    h2 { margin-top:0; }
    .meta { font-size:12px; color:#666; margin:4px 0 14px; }
    .badge { display:inline-block; background:#eef3f8; color:#123; font-size:11px; padding:2px 6px; border-radius:8px; margin:0 4px 6px 0;}
    textarea { width:100%; min-height:140px; padding:10px 12px; font-size:14px; line-height:1.5; border:1px solid #d3dce5; border-radius:10px; resize:vertical; }
    textarea:focus { outline:2px solid #0d84ff33; border-color:#0d84ff; }
    ol { padding-left:20px; }
    .empty { color:#999; font-style:italic; }
    a { color:#0d67cc; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .src-list { padding-left:20px; }
    .top-actions { display:flex; gap:10px; flex-wrap:wrap; }
    button { cursor:pointer; border:1px solid #c4ccd4; background:#fff; padding:6px 14px; border-radius:8px; font-size:13px; }
    button.primary { background:#0d84ff; border:none; color:#fff; }
    .export-box { margin-top:22px; }
    pre { background:#0f172a; color:#e2e8f0; padding:14px 16px; overflow:auto; border-radius:10px; font-size:13px; }
  </style>
</head>
<body>
  <header>
    <h1>学习卡片生成</h1>
    <div class="top-actions">
      <a href="index.html" style="color:#fff;font-size:12px;">返回聚类首页</a>
      <button id="exportJsonBtn">导出 JSON</button>
      <button id="copyMarkdownBtn">复制 Markdown</button>
    </div>
  </header>

  <main>
    <div id="cardRoot"></div>
    <div class="export-box" id="exportBox" style="display:none;">
      <h3>导出结果</h3>
      <pre id="exportContent"></pre>
    </div>
  </main>

  <script>
    function getSelectedCluster() {
      const dataStr = localStorage.getItem('selectedCluster');
      if (!dataStr) return null;
      try { return JSON.parse(dataStr); } catch { return null; }
    }

    function render(cluster) {
      const root = document.getElementById('cardRoot');
      if (!cluster) {
        root.innerHTML = '<p>未找到已选择的聚类。请回到 <a href="index.html">首页</a> 点击某个聚类内的“生成学习卡片”按钮。</p>';
        return;
      }
      const kp = (cluster.keyPoints || []).map((k,i)=>`<li>${i+1}. ${escapeHtml(k)}</li>`).join('') || '<li class="empty">（暂无）</li>';
      const tags = (cluster.tags||[]).map(t=>`<span class="badge">${escapeHtml(t)}</span>`).join('') || '<span class="empty">（无标签）</span>';
      const srcs = (cluster.sources||[]).map(s=>`<li><a href="${s.url}" target="_blank">${escapeHtml(s.title)}</a></li>`).join('');

      root.innerHTML = `
        <h2>${escapeHtml(cluster.topic || cluster.sources?.[0]?.title || '未命名主题')}</h2>
        <div class="meta">
          状态：${cluster._llmEnhanced ? 'LLM 增强完成' : '未增强'}
          ｜ 文章数：${cluster.sources?.length || 0}
          ｜ ID：${cluster.id}
        </div>
        <p><strong>摘要：</strong>${escapeHtml(cluster.summary || '（暂无摘要）')}</p>
        <p><strong>标签：</strong>${tags}</p>
        <h3>关键要点</h3>
        <ol>${kp}</ol>
        <h3>来源列表</h3>
        <ul class="src-list">${srcs}</ul>
        <h3>我的补充笔记</h3>
        <textarea id="notesArea" placeholder="写下你的理解 / 延伸想法 / 应用场景..."></textarea>
      `;
    }

    function escapeHtml(s='') {
      return s.replace(/[&<>"]/g,ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
    }

    function buildExportObject(cluster) {
      const notes = document.getElementById('notesArea')?.value || '';
      return {
        id: cluster.id,
        topic: cluster.topic,
        summary: cluster.summary,
        keyPoints: cluster.keyPoints || [],
        tags: cluster.tags || [],
        sources: cluster.sources.map(s=>({ title:s.title, url:s.url })),
        enhanced: !!cluster._llmEnhanced,
        notes,
        exportedAt: new Date().toISOString()
      };
    }

    function toMarkdown(obj) {
      const lines = [];
      lines.push(`# 学习卡片：${obj.topic}`);
      lines.push('');
      lines.push(`- 文章数：${obj.sources.length}`);
      lines.push(`- LLM 增强：${obj.enhanced ? '是' : '否'}`);
      lines.push('');
      lines.push(`## 摘要`);
      lines.push(obj.summary || '（暂无摘要）');
      lines.push('');
      lines.push('## 关键要点');
      obj.keyPoints.forEach((k,i)=>lines.push(`${i+1}. ${k}`));
      lines.push('');
      lines.push('## 标签');
      lines.push(obj.tags.join(', ') || '（无）');
      lines.push('');
      lines.push('## 来源');
      obj.sources.forEach((s,i)=>lines.push(`${i+1}. [${s.title}](${s.url})`));
      lines.push('');
      lines.push('## 我的笔记');
      lines.push(obj.notes || '（暂无）');
      lines.push('');
      lines.push(`> 导出时间：${obj.exportedAt}`);
      return lines.join('\n');
    }

    // 初始化
    const cluster = getSelectedCluster();
    render(cluster);

    document.getElementById('exportJsonBtn').addEventListener('click', ()=>{
      if (!cluster) return;
      const data = buildExportObject(cluster);
      const box = document.getElementById('exportBox');
      const pre = document.getElementById('exportContent');
      pre.textContent = JSON.stringify(data, null, 2);
      box.style.display = 'block';
    });

    document.getElementById('copyMarkdownBtn').addEventListener('click', async ()=>{
      if (!cluster) return;
      const md = toMarkdown(buildExportObject(cluster));
      try {
        await navigator.clipboard.writeText(md);
        alert('Markdown 已复制到剪贴板');
      } catch {
        // 备用方案
        const ta = document.createElement('textarea');
        ta.value = md;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        alert('Markdown 已复制（兼容模式）');
      }
    });
  </script>
</body>
</html>
