<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>学习卡片生成</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body { margin:0; font-family:system-ui; background:#f5f7fa; }
header { background:#062c4d; color:#fff; padding:14px 24px; display:flex; justify-content:space-between; align-items:center; }
header h1 { margin:0; font-size:18px; }
main { max-width:980px; margin:30px auto 60px; background:#fff; padding:28px 36px 42px; border-radius:14px; box-shadow:0 2px 6px rgba(0,0,0,.06); }
.badge { display:inline-block; background:#eef2f8; padding:2px 6px; font-size:12px; border-radius:10px; margin:0 6px 6px 0; }
.llm { background:#12b76a; color:#fff; }
h2 { margin:0 0 8px; font-size:22px; }
.section { margin-top:18px; }
ul.sources { list-style:disc; padding-left:20px; line-height:1.5; }
textarea { width:100%; min-height:140px; resize:vertical; font-family:inherit; padding:10px; border:1px solid #cbd3dd; border-radius:6px; }
.actions { margin-top:20px; display:flex; gap:14px; flex-wrap:wrap; }
button { padding:8px 18px; border:1px solid #2169e0; background:#2169e0; border-radius:6px; color:#fff; font-size:14px; cursor:pointer; }
button.secondary { background:#fff; color:#2169e0; }
pre { white-space:pre-wrap; background:#f0f4f9; padding:14px; border-radius:6px; font-size:13px; }
</style>
</head>
<body>
<header>
  <h1>学习卡片生成</h1>
  <div>
    <button class="secondary" id="btnBack">返回聚类首页</button>
    <button id="btnExportJSON" class="secondary">导出 JSON</button>
    <button id="btnCopyMD">复制 Markdown</button>
  </div>
</header>
<main id="cardRoot">
  <p>正在加载集群数据…</p>
</main>
<script type="module">
import { escapeHTML, domainOf } from './modules/news-utils.js';

function getClusterFromStorage() {
  const params = new URLSearchParams(location.search);
  const id = params.get('cluster');
  let clustersRaw = localStorage.getItem('CLUSTER_CACHE_V1');
  if(!clustersRaw) return null;
  try {
    const obj = JSON.parse(clustersRaw);
    if(!obj.clusters) return null;
    const arr = obj.clusters;
    if(id) return arr.find(c=>c.id===id) || null;
    const sel = localStorage.getItem('selectedCluster');
    if(sel) return arr.find(c=>c.id===sel)||null;
    return arr[0] || null;
  } catch(e){ return null; }
}

const cluster = getClusterFromStorage();
const root = document.getElementById('cardRoot');

if(!cluster){
  root.innerHTML = '<p>未找到 cluster 数据，请先在首页选择“生成学习卡片”。</p>';
} else {
  const keyPoints = (cluster.keyPoints && cluster.keyPoints.length)
    ? cluster.keyPoints
    : deduceKeyPoints(cluster);

  const md = buildMarkdown(cluster, keyPoints);
  window.__CARD_DEBUG__ = { cluster, keyPoints, markdown: md };

  root.innerHTML = `
    <h2>${escapeHTML(cluster.topic||'(未命名主题)')}</h2>
    <div style="font-size:13px;color:#666;margin-bottom:12px;">
      状态：${cluster._llmEnhanced ? '<span class="badge llm">LLM</span>' : '未增强'}
      | 文章数：${cluster.items.length}
      | ID: ${cluster.id}
    </div>

    <div class="section">
      <h3 style="margin:0 0 6px;">摘要：</h3>
      <div style="line-height:1.5;">${escapeHTML(cluster.summary||'（无摘要）')}</div>
    </div>

    <div class="section">
      <h3 style="margin:0 0 6px;">标签：</h3>
      ${(cluster.tags||[]).map(t=>`<span class="badge">${escapeHTML(t)}</span>`).join('')}
    </div>

    <div class="section">
      <h3 style="margin:0 0 6px;">关键要点：</h3>
      <ol style="padding-left:20px;line-height:1.5;">
        ${keyPoints.map(k=>`<li>${escapeHTML(k)}</li>`).join('')}
      </ol>
    </div>

    <div class="section">
      <h3 style="margin:0 0 6px;">来源列表：</h3>
      <ul class="sources">
        ${cluster.items.map(it => `<li><a target="_blank" rel="noopener" href="${it.url}">${escapeHTML(it.title)}</a> <span style="color:#999;font-size:12px;">(${escapeHTML(domainOf(it.url))})</span></li>`).join('')}
      </ul>
    </div>

    <div class="section">
      <h3 style="margin:0 0 6px;">自定义学习笔记：</h3>
      <textarea id="notesArea" placeholder="在此添加你的理解/记忆要点..."></textarea>
    </div>

    <div class="section">
      <h3 style="margin:0 0 6px;">Markdown 预览：</h3>
      <pre id="mdPreview"></pre>
    </div>
  `;
  document.getElementById('mdPreview').textContent = md;
}

function deduceKeyPoints(cluster){
  // 简单标题去重
  const seen = new Set();
  const points = [];
  for(const it of cluster.items){
    const base = (it.title||'').toLowerCase().trim();
    if(!base || seen.has(base)) continue;
    seen.add(base);
    points.push(it.title);
    if(points.length >= 5) break;
  }
  return points;
}

function buildMarkdown(c, keyPoints){
  return `### ${c.topic||'(未命名主题)'}\n\n` +
  `摘要：${c.summary||''}\n\n`+
  `标签：${(c.tags||[]).join(', ')}\n\n`+
  `关键要点：\n`+
  keyPoints.map((k,i)=>`${i+1}. ${k}`).join('\n') + '\n\n' +
  `来源：\n` +
  c.items.map(it=>`- ${it.title} (${domainOf(it.url)})`).join('\n') + '\n';
}

document.getElementById('btnBack').onclick = ()=>{ location.href='./index.html'; };
document.getElementById('btnExportJSON').onclick = ()=>{
  if(!cluster) return;
  const blob = new Blob([JSON.stringify(cluster,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `cluster-${cluster.id}.json`;
  a.click();
};
document.getElementById('btnCopyMD').onclick = async ()=>{
  const md = document.getElementById('mdPreview').textContent;
  await navigator.clipboard.writeText(md);
  alert('Markdown 已复制');
};
</script>
</body>
</html>
