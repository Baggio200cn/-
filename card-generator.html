<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>学习卡片</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{margin:0;font-family:system-ui;background:#f5f7fa;color:#1a1f29;}
header{background:#05315d;color:#fff;padding:12px 26px;display:flex;justify-content:space-between;align-items:center;}
main{max-width:1000px;margin:30px auto 70px;background:#fff;padding:32px 40px 40px;border-radius:16px;box-shadow:0 2px 6px rgba(0,0,0,.06);}
.badge{display:inline-block;background:#eef2f8;padding:2px 6px;font-size:12px;border-radius:10px;margin:0 6px 6px 0;}
h2{margin:0 0 6px;font-size:24px;}
section{margin-top:22px;}
ol{padding-left:20px;}
ul.sources{padding-left:20px;line-height:1.55;}
textarea{width:100%;min-height:140px;resize:vertical;font-family:inherit;padding:10px;border:1px solid #ccd3dd;border-radius:6px;}
pre{background:#f0f4f9;padding:14px 16px;font-size:13px;border-radius:6px;white-space:pre-wrap;}
button{cursor:pointer;padding:8px 16px;border:1px solid #1a63e6;background:#1a63e6;color:#fff;border-radius:6px;font-size:14px;}
button.secondary{background:#fff;color:#1a63e6;}
</style>
</head>
<body>
<header>
  <strong>学习卡片生成</strong>
  <div>
    <button id="btnBack" class="secondary">返回</button>
    <button id="btnCopy">复制 Markdown</button>
  </div>
</header>
<main id="root"><p>加载中...</p></main>

<script type="module">
function getCluster(){
  const id = new URLSearchParams(location.search).get('cluster') || localStorage.getItem('selectedCluster');
  if(!id) return null;
  try{
    const raw = localStorage.getItem('CLUSTER_CACHE_V1');
    if(!raw) return null;
    const cache = JSON.parse(raw);
    return cache.clusters.find(c=>c.id===id) || null;
  }catch{return null;}
}

const c = getCluster();
const root=document.getElementById('root');

if(!c){
  root.innerHTML='<p>未找到集群，请返回重新选择。</p>';
}else{
  const md = buildMD(c);
  root.innerHTML = `
    <h2>${escapeHTML(c.topic||'(未命名)')}</h2>
    <div style="font-size:12px;color:#666;margin-bottom:10px;">ID: ${c.id} · 文章数: ${c.items.length}</div>
    <section>
      <h3 style="margin:0 0 6px;">摘要</h3>
      <div style="line-height:1.55;">${escapeHTML(c.summary||'')}</div>
    </section>
    <section>
      <h3 style="margin:0 0 6px;">关键要点</h3>
      <ol>${(c.keyPoints||[]).map(k=>`<li>${escapeHTML(k)}</li>`).join('')}</ol>
    </section>
    <section>
      <h3 style="margin:0 0 6px;">标签</h3>
      ${(c.tags||[]).map(t=>`<span class="badge">${escapeHTML(t)}</span>`).join('')}
    </section>
    <section>
      <h3 style="margin:0 0 6px;">来源</h3>
      <ul class="sources">${c.items.map(it=>`<li><a href="${it.url}" target="_blank" rel="noopener">${escapeHTML(it.title)}</a></li>`).join('')}</ul>
    </section>
    <section>
      <h3 style="margin:0 0 6px;">自定义笔记</h3>
      <textarea placeholder="写下你的记忆要点..."></textarea>
    </section>
    <section>
      <h3 style="margin:0 0 6px;">Markdown 预览</h3>
      <pre id="mdPreview"></pre>
    </section>
  `;
  document.getElementById('mdPreview').textContent = md;
  window.__CARD__ = { markdown: md };
}

function buildMD(c){
  return `### ${c.topic||'(未命名)'}\n\n摘要：${c.summary||''}\n\n关键要点：\n` +
    (c.keyPoints||[]).map((k,i)=>`${i+1}. ${k}`).join('\n') + '\n\n来源：\n' +
    c.items.map(it=>`- ${it.title} (${it.url})`).join('\n') + '\n';
}
function escapeHTML(s=''){return s.replace(/[&<>"']/g,a=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[a]));}

document.getElementById('btnBack').onclick=()=>history.back();
document.getElementById('btnCopy').onclick=async ()=>{
  await navigator.clipboard.writeText(window.__CARD__.markdown);
  alert('已复制 Markdown');
};
</script>
</body>
</html>
