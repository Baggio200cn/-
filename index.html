<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机器视觉每日资讯</title>
    <link rel="stylesheet" href="styles/base.css">
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo-section">
                <img id="siteLogo" src="" alt="机器视觉每日资讯" class="logo">
                <h1 class="site-title">机器视觉每日资讯</h1>
            </div>
            <nav class="nav-links">
                <a href="index.html" class="active">首页</a>
                <a href="archive.html">历史归档</a>
                <a href="prompt.html">学习卡片生成器</a>
            </nav>
        </div>
    </header>

    <main>
        <div id="tagFilterContainer"></div>
        <div id="newsContainer">
            <div class="loading">加载中...</div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.js"></script>
    <script src="app-common.js"></script>
    <script>
        let allNewsData = [];
        let currentSelectedTags = [];
        let logoSrc = '';

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Detect logo
                logoSrc = await NewsUtils.detectLogo();
                
                // Load news data
                allNewsData = await NewsUtils.loadJSON('data/news.json');
                
                // Get initial tags from URL
                currentSelectedTags = NewsUtils.getSelectedTagsFromURL();
                
                // Setup tag filter
                setupTagFilter();
                
                // Render filtered news
                renderFilteredNews();
                
            } catch (error) {
                console.error('Error initializing page:', error);
                document.getElementById('newsContainer').innerHTML = 
                    '<div class="error">加载新闻数据失败，请稍后重试。</div>';
            }
        });

        // Setup tag filter
        function setupTagFilter() {
            const container = document.getElementById('tagFilterContainer');
            
            const filterContainer = document.createElement('div');
            filterContainer.className = 'tag-filter-container';
            
            const filterBar = NewsUtils.createTagFilterBar(
                allNewsData, 
                currentSelectedTags,
                handleTagChange
            );
            
            // Store reference to callback for clear button
            filterBar._onTagChange = handleTagChange;
            
            filterContainer.appendChild(filterBar);
            container.appendChild(filterContainer);
        }

        // Handle tag change
        function handleTagChange(selectedTags) {
            currentSelectedTags = selectedTags;
            
            // Update URL
            NewsUtils.updateURLWithTags(selectedTags);
            
            // Re-render news
            renderFilteredNews();
        }

        // Render filtered news
        function renderFilteredNews() {
            const filteredNews = NewsUtils.applyTagFilter(allNewsData, currentSelectedTags);
            const container = document.getElementById('newsContainer');
            
            NewsUtils.renderNewsCards(container, filteredNews, logoSrc);
        }
        
        // Handle browser back/forward
        window.addEventListener('popstate', () => {
            const newSelectedTags = NewsUtils.getSelectedTagsFromURL();
            if (JSON.stringify(newSelectedTags) !== JSON.stringify(currentSelectedTags)) {
                currentSelectedTags = newSelectedTags;
                
                // Update filter UI
                const filterBar = document.querySelector('.tag-filter-bar');
                if (filterBar) {
                    NewsUtils.updateTagFilterUI(filterBar, currentSelectedTags);
                    filterBar._onTagChange = handleTagChange; // Restore callback
                }
                
                // Re-render news
                renderFilteredNews();
            }
        });
    </script>
</body>
</html>