<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Êú∫Âô®ËßÜËßâÊØèÊó•ËµÑËÆØ - AI Clustering</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="styles/base.css?v=v4">
<style>
/* Clustering UI Styles */
.clustering-toolbar {
  background: var(--color-bg-alt);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: 1rem;
  margin: 1rem 0;
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: center;
}

.clustering-controls {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.clustering-controls button {
  padding: 0.5rem 1rem;
  border: 1px solid var(--color-border-strong);
  border-radius: var(--radius-md);
  background: var(--color-bg);
  color: var(--color-text);
  font-size: 0.875rem;
  cursor: pointer;
  transition: var(--transition);
}

.clustering-controls button:hover {
  background: var(--color-primary-soft);
}

.clustering-controls button.active {
  background: var(--color-primary);
  color: white;
}

.llm-panel {
  background: var(--color-bg-alt);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  margin: 1rem 0;
  overflow: hidden;
}

.llm-panel-header {
  background: var(--color-primary-soft);
  padding: 1rem;
  border-bottom: 1px solid var(--color-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.llm-panel-content {
  padding: 1rem;
  display: none;
}

.llm-panel.expanded .llm-panel-content {
  display: block;
}

.llm-config-form {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 0.25rem;
  color: var(--color-text);
}

.form-group input, .form-group select {
  padding: 0.5rem;
  border: 1px solid var(--color-border-strong);
  border-radius: var(--radius-md);
  font-size: 0.875rem;
}

.llm-actions {
  margin-top: 1rem;
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.llm-actions button {
  padding: 0.5rem 1rem;
  border: 1px solid var(--color-border-strong);
  border-radius: var(--radius-md);
  background: var(--color-bg);
  color: var(--color-text);
  font-size: 0.875rem;
  cursor: pointer;
  transition: var(--transition);
}

.llm-actions .btn-primary {
  background: var(--color-primary);
  color: white;
  border-color: var(--color-primary);
}

.llm-actions button:hover {
  opacity: 0.8;
}

.llm-actions button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.llm-status {
  margin-top: 1rem;
  padding: 0.75rem;
  border-radius: var(--radius-md);
  font-size: 0.875rem;
  display: none;
}

.llm-status.success {
  background: #d1fae5;
  color: #065f46;
  border: 1px solid #a7f3d0;
}

.llm-status.error {
  background: #fee2e2;
  color: #991b1b;
  border: 1px solid #fca5a5;
}

.llm-status.info {
  background: #dbeafe;
  color: #1e40af;
  border: 1px solid #93c5fd;
}

.cluster-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 1.5rem;
  margin: 1rem 0;
}

.cluster-card {
  background: var(--color-bg-alt);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
  box-shadow: var(--shadow-md);
  transition: var(--transition);
  cursor: pointer;
}

.cluster-card:hover {
  box-shadow: var(--shadow-lg);
  transform: translateY(-2px);
}

.cluster-card.selected {
  border-color: var(--color-primary);
  background: var(--color-primary-soft);
}

.cluster-card.enhanced {
  border-left: 4px solid #10b981;
}

.cluster-card.llm-error {
  border-left: 4px solid #ef4444;
}

.cluster-header {
  margin-bottom: 1rem;
}

.cluster-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--color-text);
  margin: 0 0 0.5rem 0;
}

.cluster-meta {
  display: flex;
  gap: 1rem;
  font-size: 0.75rem;
  color: var(--color-text-dim);
  flex-wrap: wrap;
}

.enhanced-badge {
  background: #10b981;
  color: white;
  padding: 0.125rem 0.5rem;
  border-radius: var(--radius-sm);
}

.error-badge {
  background: #ef4444;
  color: white;
  padding: 0.125rem 0.5rem;
  border-radius: var(--radius-sm);
}

.cluster-summary {
  margin-bottom: 1rem;
  font-size: 0.875rem;
  line-height: 1.5;
  color: var(--color-text-dim);
}

.cluster-keypoints {
  margin-bottom: 1rem;
}

.cluster-keypoints h4 {
  font-size: 0.875rem;
  font-weight: 600;
  margin: 0 0 0.5rem 0;
}

.cluster-keypoints ul {
  margin: 0;
  padding-left: 1.5rem;
  font-size: 0.875rem;
}

.cluster-keypoints li {
  margin-bottom: 0.25rem;
}

.cluster-tags {
  margin-bottom: 1rem;
}

.tag {
  display: inline-block;
  background: var(--color-primary-soft);
  color: var(--color-primary);
  padding: 0.25rem 0.5rem;
  border-radius: var(--radius-sm);
  font-size: 0.75rem;
  margin: 0.125rem;
}

.tag-more {
  display: inline-block;
  color: var(--color-text-dim);
  font-size: 0.75rem;
  margin: 0.125rem;
}

.cluster-sources {
  font-size: 0.75rem;
  color: var(--color-text-dim);
  margin-bottom: 1rem;
}

.cluster-preview {
  margin-bottom: 1rem;
}

.preview-item {
  margin-bottom: 0.75rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--color-border);
}

.preview-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.preview-title {
  font-size: 0.875rem;
  font-weight: 500;
  margin: 0 0 0.25rem 0;
}

.preview-title a {
  color: var(--color-text);
  text-decoration: none;
}

.preview-title a:hover {
  color: var(--color-primary);
}

.preview-meta {
  font-size: 0.75rem;
  color: var(--color-text-dim);
  display: flex;
  gap: 1rem;
}

.preview-more {
  font-size: 0.75rem;
  color: var(--color-text-dim);
  font-style: italic;
}

.cluster-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.cluster-actions button {
  padding: 0.5rem 1rem;
  border: 1px solid var(--color-border-strong);
  border-radius: var(--radius-md);
  background: var(--color-bg);
  color: var(--color-text);
  font-size: 0.75rem;
  cursor: pointer;
  transition: var(--transition);
}

.cluster-actions button:hover {
  background: var(--color-primary-soft);
}

.empty-state, .loading-state, .error-state {
  text-align: center;
  padding: 3rem 2rem;
  color: var(--color-text-dim);
}

.empty-icon, .error-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--color-border);
  border-top: 4px solid var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.cluster-details {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--color-bg);
  z-index: 1000;
  overflow: auto;
  padding: 2rem;
}

.cluster-details-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--color-border);
}

.btn-close-details {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--color-text-dim);
  padding: 0.5rem;
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 1rem 1.5rem;
  border-radius: var(--radius-md);
  color: white;
  font-size: 0.875rem;
  z-index: 2000;
  animation: slideIn 0.3s ease-out;
}

.notification-success {
  background: #10b981;
}

.notification-error {
  background: #ef4444;
}

.notification-info {
  background: #3b82f6;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Responsive design */
@media (max-width: 768px) {
  .clustering-toolbar {
    flex-direction: column;
    align-items: stretch;
  }
  
  .clustering-controls {
    justify-content: center;
  }
  
  .cluster-grid {
    grid-template-columns: 1fr;
  }
  
  .llm-config-form {
    grid-template-columns: 1fr;
  }
  
  .cluster-details {
    padding: 1rem;
  }
}
</style>
</head>
<body>
<header class="site-header">
  <div class="logo-wrap">
    <img id="siteLogo" alt="logo" />
    <h1>Êú∫Âô®ËßÜËßâÊØèÊó•ËµÑËÆØ</h1>
  </div>
  <div class="header-actions">
    <button id="langToggleBtn" class="ghost-btn">‰∏≠/EN</button>
    <a href="legacy-index.html" class="ghost-btn">Legacy View</a>
    <a href="card-generator.html" class="primary small">Â≠¶‰π†Âç°ÁâáÁîüÊàê</a>
  </div>
</header>

<section class="clustering-toolbar">
  <div class="clustering-controls">
    <button id="refreshClustersBtn">üîÑ Refresh Clusters</button>
    <button id="clearCacheBtn">üóëÔ∏è Clear Cache</button>
    <button id="toggleLLMBtn">ü§ñ LLM Enhancement</button>
  </div>
  <div id="clusterStats" class="cluster-stats">
    <span id="clusterCount">0 clusters</span> ‚Ä¢ 
    <span id="itemCount">0 items</span> ‚Ä¢ 
    <span id="processTime">0ms</span>
  </div>
</section>

<section class="llm-panel" id="llmPanel">
  <div class="llm-panel-header">
    <h3>ü§ñ LLM Enhancement Configuration</h3>
    <button id="toggleLLMPanelBtn">‚ñº</button>
  </div>
  <div class="llm-panel-content">
    <form class="llm-config-form" id="llmConfigForm">
      <div class="form-group">
        <label for="apiBase">API Base URL</label>
        <input type="url" id="apiBase" placeholder="https://api.openai.com/v1" required>
      </div>
      <div class="form-group">
        <label for="apiKey">API Key</label>
        <input type="password" id="apiKey" placeholder="sk-..." required>
      </div>
      <div class="form-group">
        <label for="model">Model</label>
        <select id="model">
          <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
          <option value="gpt-4">GPT-4</option>
          <option value="gpt-4-turbo">GPT-4 Turbo</option>
        </select>
      </div>
      <div class="form-group">
        <label for="batchSize">Batch Size</label>
        <input type="number" id="batchSize" min="1" max="10" value="3">
      </div>
    </form>
    
    <div class="llm-actions">
      <button type="button" id="testLLMBtn" class="btn-primary">Test Configuration</button>
      <button type="button" id="saveLLMConfigBtn">Save Configuration</button>
      <button type="button" id="runLLMEnhancementBtn" class="btn-primary">Run Enhancement</button>
    </div>
    
    <div id="llmStatus" class="llm-status"></div>
  </div>
</section>

<main>
  <div id="clusterContainer" class="cluster-grid"></div>
  <div id="clusterDetails" style="display: none;"></div>
</main>

<script type="module">
import { dataLoader } from './modules/data-loader.js';
import { cacheUtils } from './modules/cache-utils.js';
import { clusterEngine } from './modules/cluster-engine.js';
import { cardRenderer } from './modules/card-renderer.js';
import { llmTopicEnhancer } from './modules/llm-topic.js';

// Initialize application
class ClusteringApp {
  constructor() {
    this.clusters = [];
    this.newsData = [];
    this.isLoading = false;
    
    this.initializeElements();
    this.setupEventListeners();
    this.loadInitialData();
    this.loadLLMConfig();
  }

  initializeElements() {
    this.clusterContainer = document.getElementById('clusterContainer');
    this.clusterDetails = document.getElementById('clusterDetails');
    this.llmPanel = document.getElementById('llmPanel');
    this.llmConfigForm = document.getElementById('llmConfigForm');
    this.llmStatus = document.getElementById('llmStatus');
    
    // Initialize card renderer
    cardRenderer.init(this.clusterContainer);
  }

  setupEventListeners() {
    // Clustering controls
    document.getElementById('refreshClustersBtn').addEventListener('click', () => this.refreshClusters());
    document.getElementById('clearCacheBtn').addEventListener('click', () => this.clearCache());
    document.getElementById('toggleLLMBtn').addEventListener('click', () => this.toggleLLMPanel());
    
    // LLM panel controls
    document.getElementById('toggleLLMPanelBtn').addEventListener('click', () => this.toggleLLMPanel());
    document.getElementById('testLLMBtn').addEventListener('click', () => this.testLLMConfig());
    document.getElementById('saveLLMConfigBtn').addEventListener('click', () => this.saveLLMConfig());
    document.getElementById('runLLMEnhancementBtn').addEventListener('click', () => this.runLLMEnhancement());
    
    // Custom events
    document.addEventListener('clusterSelected', (e) => this.handleClusterSelected(e.detail.clusterId));
    document.addEventListener('clusterExpand', (e) => this.handleClusterExpand(e.detail.clusterId));
  }

  async loadInitialData() {
    try {
      this.showLoadingState();
      this.newsData = await dataLoader.loadNews();
      await this.clusterNews();
    } catch (error) {
      console.error('Error loading initial data:', error);
      this.showErrorState(error.message);
    }
  }

  async clusterNews() {
    try {
      const newsHash = cacheUtils.constructor.hash(this.newsData);
      
      // Try to load from cache first
      const cachedClusters = cacheUtils.getClusters(newsHash);
      if (cachedClusters) {
        this.clusters = cachedClusters;
        this.renderClusters();
        this.updateStats(clusterEngine.getDiagnostics());
        return;
      }
      
      // Perform clustering
      this.clusters = clusterEngine.clusterNews(this.newsData);
      
      // Cache results
      cacheUtils.setClusters(this.clusters, newsHash);
      
      // Render and update stats
      this.renderClusters();
      this.updateStats(clusterEngine.getDiagnostics());
      
      // Expose to window for debugging
      window.__CLUSTERS__ = this.clusters;
      window.__CLUSTER_DIAG__ = () => clusterEngine.getDiagnostics();
      
    } catch (error) {
      console.error('Error clustering news:', error);
      this.showErrorState(error.message);
    }
  }

  renderClusters() {
    cardRenderer.renderClusters(this.clusters);
  }

  async refreshClusters() {
    if (this.isLoading) return;
    
    this.isLoading = true;
    try {
      // Clear cache and reload
      const newsHash = cacheUtils.constructor.hash(this.newsData);
      cacheUtils.remove(cacheUtils.getCacheKey('clusters', 'CLUSTER_CACHE_V1'));
      
      await this.clusterNews();
    } finally {
      this.isLoading = false;
    }
  }

  clearCache() {
    cacheUtils.clearVersion('CLUSTER_CACHE_V1');
    this.refreshClusters();
  }

  showLoadingState() {
    cardRenderer.renderLoadingState();
  }

  showErrorState(message) {
    cardRenderer.renderErrorState(message);
  }

  updateStats(diagnostics) {
    document.getElementById('clusterCount').textContent = `${diagnostics.clusterCount} clusters`;
    document.getElementById('itemCount').textContent = `${diagnostics.itemCount} items`;
    document.getElementById('processTime').textContent = `${diagnostics.processTime}ms`;
  }

  toggleLLMPanel() {
    this.llmPanel.classList.toggle('expanded');
    const btn = document.getElementById('toggleLLMPanelBtn');
    btn.textContent = this.llmPanel.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
  }

  loadLLMConfig() {
    const config = llmTopicEnhancer.getConfig();
    document.getElementById('apiBase').value = config.apiBase || '';
    document.getElementById('apiKey').value = config.apiKey || '';
    document.getElementById('model').value = config.model || 'gpt-3.5-turbo';
    document.getElementById('batchSize').value = config.batchSize || 3;
  }

  saveLLMConfig() {
    const config = {
      apiBase: document.getElementById('apiBase').value,
      apiKey: document.getElementById('apiKey').value,
      model: document.getElementById('model').value,
      batchSize: parseInt(document.getElementById('batchSize').value)
    };
    
    llmTopicEnhancer.updateConfig(config);
    this.showLLMStatus('Configuration saved successfully', 'success');
  }

  async testLLMConfig() {
    try {
      this.showLLMStatus('Testing configuration...', 'info');
      
      // Save current config first
      this.saveLLMConfig();
      
      const result = await llmTopicEnhancer.testConfiguration();
      
      if (result.success) {
        this.showLLMStatus('Configuration test successful!', 'success');
      } else {
        this.showLLMStatus(`Configuration test failed: ${result.error}`, 'error');
      }
    } catch (error) {
      this.showLLMStatus(`Test error: ${error.message}`, 'error');
    }
  }

  async runLLMEnhancement() {
    if (llmTopicEnhancer.isEnhancing()) {
      this.showLLMStatus('Enhancement already in progress', 'info');
      return;
    }

    try {
      this.showLLMStatus('Starting LLM enhancement...', 'info');
      
      const enhancedClusters = await llmTopicEnhancer.enhanceClusters(
        this.clusters,
        (progress) => {
          this.showLLMStatus(
            `Enhancing clusters: ${progress.completed}/${progress.total} (${progress.percentage}%)`,
            'info'
          );
        }
      );
      
      this.clusters = enhancedClusters;
      this.renderClusters();
      
      // Update cache
      const newsHash = cacheUtils.constructor.hash(this.newsData);
      cacheUtils.setClusters(this.clusters, newsHash);
      
      this.showLLMStatus('LLM enhancement completed successfully!', 'success');
      
    } catch (error) {
      this.showLLMStatus(`Enhancement failed: ${error.message}`, 'error');
    }
  }

  showLLMStatus(message, type) {
    this.llmStatus.textContent = message;
    this.llmStatus.className = `llm-status ${type}`;
    this.llmStatus.style.display = 'block';
    
    // Auto-hide success messages
    if (type === 'success') {
      setTimeout(() => {
        this.llmStatus.style.display = 'none';
      }, 3000);
    }
  }

  handleClusterSelected(clusterId) {
    console.log('Cluster selected:', clusterId);
    // Selection is handled by the card renderer
  }

  handleClusterExpand(clusterId) {
    const cluster = this.clusters.find(c => c.id === clusterId);
    if (cluster) {
      cardRenderer.renderClusterDetails(cluster, this.clusterDetails);
      this.clusterDetails.style.display = 'block';
    }
  }
}

// Initialize logo loading
const LOGO_CANDIDATES = [
  'assets/seerboldorÊ†áËØÜÈ´òÊ∏ÖÁâà.png',
  'assets/company-logo.svg',
  'assets/company-logo.png',
  'assets/logo-placeholder.svg'
];

async function loadLogo() {
  const img = document.getElementById('siteLogo');
  if (!img) return;
  for (const p of LOGO_CANDIDATES) {
    try {
      const r = await fetch(p + '?v=v4', { cache: 'reload' });
      if (r.ok) { img.src = URL.createObjectURL(await r.blob()); return; }
    } catch {}
  }
}

// Start application
document.addEventListener('DOMContentLoaded', () => {
  loadLogo();
  new ClusteringApp();
});
</script>
</body>
</html>
